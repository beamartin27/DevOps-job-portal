# Azure DevOps Pipeline for Job Portal Application
# This pipeline builds, tests, and deploys using ZIP deployment

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - README.md
      - docs/*

pr:
  branches:
    include:
      - main
      - develop

variables:
  # Azure Web App names (update these with your actual names)
  backendWebAppName: 'job-portal-backend-app'
  frontendWebAppName: 'job-portal-frontend-app'
  
  # Resource group
  azureResourceGroup: 'job-portal-rg'
  
  # Azure subscription service connection (update with your connection name)
  azureSubscription: 'your-azure-subscription-connection'
  
  # Node version
  nodeVersion: '20.x'

stages:
  # ==================== BUILD & TEST STAGE ====================
  - stage: BuildAndTest
    displayName: 'Build and Test'
    jobs:
      # Backend Build & Test
      - job: BackendBuildTest
        displayName: 'Backend - Build & Test'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Install Node.js'

          - script: |
              npm ci
            displayName: 'Install backend dependencies'
            workingDirectory: '$(System.DefaultWorkingDirectory)'

          - script: |
              npm run test:ci
            displayName: 'Run backend tests'
            workingDirectory: '$(System.DefaultWorkingDirectory)'
            continueOnError: false

          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/junit.xml'
              mergeTestResults: true
              failTaskOnFailedTests: true
            displayName: 'Publish backend test results'
            condition: always()

      # Frontend Build & Test
      - job: FrontendBuildTest
        displayName: 'Frontend - Build & Test'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Install Node.js'

          - script: |
              npm ci
            displayName: 'Install frontend dependencies'
            workingDirectory: '$(System.DefaultWorkingDirectory)/client'

          - script: |
              npm test -- --watchAll=false --passWithNoTests --ci
            displayName: 'Run frontend tests'
            workingDirectory: '$(System.DefaultWorkingDirectory)/client'
            continueOnError: false

          - script: |
              REACT_APP_API_URL=/api npm run build
            displayName: 'Build frontend'
            workingDirectory: '$(System.DefaultWorkingDirectory)/client'
            env:
              CI: 'true'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/client/build'
              ArtifactName: 'frontend-build'
            displayName: 'Publish frontend build artifact'

  # ==================== PACKAGE STAGE ====================
  - stage: Package
    displayName: 'Package for Deployment'
    dependsOn: BuildAndTest
    condition: succeeded()
    jobs:
      - job: PackageBackend
        displayName: 'Package Backend'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Install Node.js'

          - script: |
              npm ci --production
            displayName: 'Install production dependencies'
            workingDirectory: '$(System.DefaultWorkingDirectory)'

          - script: |
              mkdir -p deploy/backend
              cp -r server deploy/backend/
              cp -r config deploy/backend/ 2>/dev/null || true
              cp package.json deploy/backend/
              cp package-lock.json deploy/backend/ 2>/dev/null || true
              cp web.config deploy/backend/ 2>/dev/null || true
            displayName: 'Copy backend files'
            workingDirectory: '$(System.DefaultWorkingDirectory)'

          - task: ArchiveFiles@2
            inputs:
              rootFolderOrFile: '$(System.DefaultWorkingDirectory)/deploy/backend'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/backend.zip'
              replaceExistingArchive: true
            displayName: 'Create backend zip'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/backend.zip'
              ArtifactName: 'backend-package'
            displayName: 'Publish backend package'

      - job: PackageFrontend
        displayName: 'Package Frontend'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - download: current
            artifact: frontend-build
            displayName: 'Download frontend build'

          - task: ArchiveFiles@2
            inputs:
              rootFolderOrFile: '$(Pipeline.Workspace)/frontend-build/build'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/frontend.zip'
              replaceExistingArchive: true
            displayName: 'Create frontend zip'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/frontend.zip'
              ArtifactName: 'frontend-package'
            displayName: 'Publish frontend package'

  # ==================== DEPLOY TO STAGING ====================
  - stage: DeployStaging
    displayName: 'Deploy to Staging'
    dependsOn: Package
    condition: succeeded()
    jobs:
      - deployment: DeployBackendStaging
        displayName: 'Deploy Backend to Staging'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'staging'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: backend-package
                  displayName: 'Download backend package'

                - task: AzureWebApp@1
                  displayName: 'Deploy backend to Azure App Service'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    appName: '$(backendWebAppName)-staging'
                    package: '$(Pipeline.Workspace)/backend-package/backend.zip'
                    deploymentMethod: 'zipDeploy'

      - deployment: DeployFrontendStaging
        displayName: 'Deploy Frontend to Staging'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'staging'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: frontend-package
                  displayName: 'Download frontend package'

                - task: AzureWebApp@1
                  displayName: 'Deploy frontend to Azure App Service'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    appName: '$(frontendWebAppName)-staging'
                    package: '$(Pipeline.Workspace)/frontend-package/frontend.zip'
                    deploymentMethod: 'zipDeploy'

  # ==================== DEPLOY TO PRODUCTION ====================
  - stage: DeployProduction
    displayName: 'Deploy to Production'
    dependsOn: DeployStaging
    condition: succeeded()
    jobs:
      - deployment: DeployBackendProduction
        displayName: 'Deploy Backend to Production'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: backend-package
                  displayName: 'Download backend package'

                - task: AzureWebApp@1
                  displayName: 'Deploy backend to Azure App Service'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    appName: '$(backendWebAppName)'
                    package: '$(Pipeline.Workspace)/backend-package/backend.zip'
                    deploymentMethod: 'zipDeploy'

      - deployment: DeployFrontendProduction
        displayName: 'Deploy Frontend to Production'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: frontend-package
                  displayName: 'Download frontend package'

                - task: AzureWebApp@1
                  displayName: 'Deploy frontend to Azure App Service'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    appName: '$(frontendWebAppName)'
                    package: '$(Pipeline.Workspace)/frontend-package/frontend.zip'
                    deploymentMethod: 'zipDeploy'
